{
  "name": "Real Price Scraper - Turkish Markets",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "hours",
              "hoursInterval": 12
            }
          ]
        }
      },
      "name": "Every 12 Hours",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1,
      "position": [240, 300]
    },
    {
      "parameters": {
        "functionCode": "// T�rkiye'deki pop�ler marketler ve �r�nler\nconst products = [\n  's�t', 'ekmek', 'yumurta', 'domates', 'salatalik', \n  'tavuk', 'pirin�', 'makarna', 'zeytinyagi', 'peynir',\n  'yogurt', 'muz', 'elma', 'patates', 'sogan'\n];\n\nconst markets = [\n  {\n    name: 'Migros',\n    baseUrl: 'https://www.migros.com.tr',\n    searchUrl: 'https://www.migros.com.tr/arama?q=',\n    selectors: {\n      productCard: '.product-card',\n      name: '.product-name',\n      price: '.price-new',\n      image: 'img'\n    }\n  },\n  {\n    name: 'CarrefourSA',\n    baseUrl: 'https://www.carrefoursa.com',\n    searchUrl: 'https://www.carrefoursa.com/search/?text=',\n    selectors: {\n      productCard: '.product-item',\n      name: '.item-name',\n      price: '.item-price',\n      image: 'img'\n    }\n  },\n  {\n    name: 'A101',\n    baseUrl: 'https://www.a101.com.tr',\n    searchUrl: 'https://www.a101.com.tr/market/ara?q=',\n    selectors: {\n      productCard: '.product',\n      name: '.name',\n      price: '.price',\n      image: 'img'\n    }\n  },\n  {\n    name: 'BIM',\n    baseUrl: 'https://www.bim.com.tr',\n    searchUrl: 'https://www.bim.com.tr/Categories/100/urun-ara.aspx?keyword=',\n    selectors: {\n      productCard: '.product-box',\n      name: '.product-name',\n      price: '.product-price',\n      image: 'img'\n    }\n  },\n  {\n    name: 'Sok',\n    baseUrl: 'https://www.sokmarket.com.tr',\n    searchUrl: 'https://www.sokmarket.com.tr/arama?q=',\n    selectors: {\n      productCard: '.product',\n      name: '.product-name',\n      price: '.product-price',\n      image: 'img'\n    }\n  }\n];\n\n// Her market-�r�n kombinasyonu i�in item olustur\nconst items = [];\nproducts.forEach(product => {\n  markets.forEach(market => {\n    items.push({\n      json: {\n        product: product,\n        market: market.name,\n        searchUrl: market.searchUrl + encodeURIComponent(product),\n        baseUrl: market.baseUrl,\n        selectors: market.selectors,\n        timestamp: new Date().toISOString()\n      }\n    });\n  });\n});\n\nreturn items;"
      },
      "name": "Prepare Scraping Jobs",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [460, 300]
    },
    {
      "parameters": {
        "batchSize": 5,
        "options": {
          "reset": false
        }
      },
      "name": "Batch Requests",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 1,
      "position": [680, 300]
    },
    {
      "parameters": {
        "url": "={{$json.searchUrl}}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "User-Agent",
              "value": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
            },
            {
              "name": "Accept",
              "value": "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8"
            },
            {
              "name": "Accept-Language",
              "value": "tr-TR,tr;q=0.9,en-US;q=0.8,en;q=0.7"
            },
            {
              "name": "Accept-Encoding",
              "value": "gzip, deflate, br"
            },
            {
              "name": "Connection",
              "value": "keep-alive"
            },
            {
              "name": "Upgrade-Insecure-Requests",
              "value": "1"
            }
          ]
        },
        "options": {
          "timeout": 15000,
          "redirect": {
            "redirect": {
              "followRedirects": true,
              "maxRedirects": 5
            }
          }
        }
      },
      "name": "Fetch Market Page",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [900, 300]
    },
    {
      "parameters": {
        "functionCode": "// HTML'den fiyat bilgilerini �ikar (basit regex ile)\ntry {\n  const html = items[0].binary?.data?.toString() || items[0].json?.body || '';\n  const metadata = items[0].json;\n  \n  if (!html) {\n    return [{\n      json: {\n        ...metadata,\n        error: 'No HTML content',\n        price: null,\n        available: false\n      }\n    }];\n  }\n  \n  // Fiyat pattern'leri (TL, ?, virg�l/nokta ile)\n  const pricePatterns = [\n    /([0-9]+[,.]?[0-9]*)[\\s]*(?:TL|?)/gi,\n    /(?:TL|?)[\\s]*([0-9]+[,.]?[0-9]*)/gi,\n    /\"price\"[\\s]*:[\\s]*\"?([0-9]+[,.]?[0-9]*)\"?/gi,\n    /data-price[\\s]*=[\\s]*\"([0-9]+[,.]?[0-9]*)\"/gi\n  ];\n  \n  let prices = [];\n  \n  // T�m pattern'leri dene\n  pricePatterns.forEach(pattern => {\n    let match;\n    while ((match = pattern.exec(html)) !== null) {\n      const priceStr = match[1].replace(',', '.');\n      const price = parseFloat(priceStr);\n      \n      // Makul fiyat araligi (0.50 TL - 500 TL)\n      if (price >= 0.5 && price <= 500) {\n        prices.push(price);\n      }\n    }\n  });\n  \n  // En d�s�k fiyati al (genellikle dogru fiyattir)\n  const finalPrice = prices.length > 0 ? Math.min(...prices) : null;\n  \n  // �r�n adini HTML'den �ikarmaya �alis\n  const productNameMatch = html.match(/<title>([^<]+)<\\/title>/i);\n  const scrapedName = productNameMatch ? productNameMatch[1].substring(0, 100) : null;\n  \n  return [{\n    json: {\n      product: metadata.product,\n      market: metadata.market,\n      price: finalPrice,\n      priceFormatted: finalPrice ? `${finalPrice.toFixed(2)} TL` : 'N/A',\n      available: finalPrice !== null,\n      scrapedName: scrapedName,\n      pricesFound: prices.length,\n      allPrices: prices.slice(0, 5), // Ilk 5 fiyat\n      timestamp: metadata.timestamp,\n      searchUrl: metadata.searchUrl\n    }\n  }];\n} catch (error) {\n  console.error('Scraping error:', error.message);\n  return [{\n    json: {\n      product: items[0].json.product,\n      market: items[0].json.market,\n      error: error.message,\n      price: null,\n      available: false\n    }\n  }];\n}"
      },
      "name": "Extract Price Data",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1120, 300]
    },
    {
      "parameters": {
        "functionCode": "// T�m scraping sonu�larini topla ve analiz et\ntry {\n  const results = items.map(item => item.json);\n  \n  // �r�n bazinda grupla\n  const productGroups = {};\n  \n  results.forEach(result => {\n    if (!result.available || !result.price) return;\n    \n    if (!productGroups[result.product]) {\n      productGroups[result.product] = {\n        product: result.product,\n        prices: [],\n        markets: []\n      };\n    }\n    \n    productGroups[result.product].prices.push({\n      market: result.market,\n      price: result.price,\n      priceFormatted: result.priceFormatted\n    });\n    \n    productGroups[result.product].markets.push(result.market);\n  });\n  \n  // Her �r�n i�in analiz\n  const analysis = Object.values(productGroups).map(group => {\n    const prices = group.prices.map(p => p.price);\n    const minPrice = Math.min(...prices);\n    const maxPrice = Math.max(...prices);\n    const avgPrice = prices.reduce((a, b) => a + b, 0) / prices.length;\n    \n    const cheapest = group.prices.find(p => p.price === minPrice);\n    const expensive = group.prices.find(p => p.price === maxPrice);\n    \n    return {\n      product: group.product,\n      cheapestStore: cheapest.market,\n      cheapestPrice: minPrice.toFixed(2),\n      mostExpensiveStore: expensive.market,\n      mostExpensivePrice: maxPrice.toFixed(2),\n      averagePrice: avgPrice.toFixed(2),\n      priceRange: (maxPrice - minPrice).toFixed(2),\n      savingsPercentage: ((maxPrice - minPrice) / maxPrice * 100).toFixed(1),\n      availableIn: group.markets.length,\n      allPrices: group.prices\n    };\n  });\n  \n  // �zet istatistikler\n  const summary = {\n    totalProducts: analysis.length,\n    totalScraped: results.length,\n    successfulScrapes: results.filter(r => r.available).length,\n    failedScrapes: results.filter(r => !r.available).length,\n    averageSavingsOpportunity: analysis.length > 0 ? \n      (analysis.reduce((sum, a) => sum + parseFloat(a.priceRange), 0) / analysis.length).toFixed(2) : 0,\n    timestamp: new Date().toISOString()\n  };\n  \n  return [{\n    json: {\n      analysis: analysis,\n      summary: summary,\n      rawResults: results.filter(r => r.available)\n    }\n  }];\n} catch (error) {\n  console.error('Aggregation error:', error.message);\n  return [{\n    json: {\n      error: true,\n      message: error.message\n    }\n  }];\n}"
      },
      "name": "Aggregate Results",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1340, 300]
    },
    {
      "parameters": {
        "url": "http://nginx-proxy/api/webhook/scraped-prices",
        "method": "POST",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "json",
        "jsonBody": "={{ { \"analysis\": $json.analysis, \"summary\": $json.summary, \"timestamp\": $json.summary.timestamp } }}",
        "options": {
          "timeout": 10000
        }
      },
      "name": "Save to Database",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [1560, 300]
    },
    {
      "parameters": {
        "functionCode": "// Scraping raporu formatla\ntry {\n  const data = items[0].json;\n  \n  // En iyi firsatlar (en y�ksek tasarruf)\n  const topDeals = [...data.analysis]\n    .sort((a, b) => parseFloat(b.priceRange) - parseFloat(a.priceRange))\n    .slice(0, 10);\n  \n  const dealsList = topDeals.map((deal, i) => \n    `${i + 1}. **${deal.product}**\\n` +\n    `   +- En ucuz: ${deal.cheapestStore} (${deal.cheapestPrice} TL)\\n` +\n    `   +- En pahali: ${deal.mostExpensiveStore} (${deal.mostExpensivePrice} TL)\\n` +\n    `   +- Tasarruf: ${deal.priceRange} TL (%${deal.savingsPercentage})`\n  ).join('\\n\\n');\n  \n  const message = `??? **Ger�ek Fiyat Scraping Raporu**\\n\\n` +\n    `?? **�zet:**\\n` +\n    `� Taranan �r�n: ${data.summary.totalProducts}\\n` +\n    `� Basarili: ${data.summary.successfulScrapes}/${data.summary.totalScraped}\\n` +\n    `� Ortalama tasarruf firsati: ${data.summary.averageSavingsOpportunity} TL\\n\\n` +\n    `?? **En Iyi 10 Firsat:**\\n${dealsList}\\n\\n` +\n    `? ${new Date(data.summary.timestamp).toLocaleString('tr-TR')}`;\n  \n  return [{\n    json: {\n      message: message,\n      analysis: data.analysis,\n      summary: data.summary\n    }\n  }];\n} catch (error) {\n  return [{\n    json: {\n      error: true,\n      message: error.message\n    }\n  }];\n}"
      },
      "name": "Format Report",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1780, 300]
    },
    {
      "parameters": {
        "url": "https://api.telegram.org/bot<YOUR_BOT_TOKEN>/sendMessage",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "method": "POST",
        "sendBody": true,
        "contentType": "json",
        "jsonBody": "={{ { \"chat_id\": \"<YOUR_CHAT_ID>\", \"text\": $json.message, \"parse_mode\": \"Markdown\" } }}",
        "options": {
          "timeout": 10000
        }
      },
      "name": "Send Telegram Report",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [2000, 300]
    }
  ],
  "connections": {
    "Every 12 Hours": {
      "main": [[{ "node": "Prepare Scraping Jobs", "type": "main", "index": 0 }]]
    },
    "Prepare Scraping Jobs": {
      "main": [[{ "node": "Batch Requests", "type": "main", "index": 0 }]]
    },
    "Batch Requests": {
      "main": [[{ "node": "Fetch Market Page", "type": "main", "index": 0 }]]
    },
    "Fetch Market Page": {
      "main": [[{ "node": "Extract Price Data", "type": "main", "index": 0 }]]
    },
    "Extract Price Data": {
      "main": [[{ "node": "Aggregate Results", "type": "main", "index": 0 }]]
    },
    "Aggregate Results": {
      "main": [[
        { "node": "Save to Database", "type": "main", "index": 0 },
        { "node": "Format Report", "type": "main", "index": 0 }
      ]]
    },
    "Format Report": {
      "main": [[{ "node": "Send Telegram Report", "type": "main", "index": 0 }]]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "id": "real-price-scraper"
}
